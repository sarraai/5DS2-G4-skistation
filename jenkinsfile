pipeline {
    environment {
        registry = "sarraai/skiexam"
        registryCredential = 'dockerHub'
        dockerImage = ''
    }
    agent any

    stages {
        
        stage('CHECKOUT GIT') {
            steps {
                echo 'Cloning GitHub repository...'
                git branch: 'sarra', url: 'https://github.com/sarraai/5DS2-G4-skistation.git'
            }
        }

        stage('MVN CLEAN') {
            steps {
                echo 'Running Maven clean...'
                sh 'mvn -f gestion-station-ski/pom.xml clean' // Update path here if necessary
            }
        }

        stage('ARTIFACT CONSTRUCTION') {
            steps {
                echo 'Building Maven package...'
                sh 'mvn -f gestion-station-ski/pom.xml package -Dmaven.test.skip=true -P test-coverage' // Ensure correct path
            }
        }

        stage('CHECK DATABASE CONNECTION') {
            steps {
                script {
                    echo 'Checking database connection...'
                    def dbHost = 'your_database_host' // Replace with your database host
                    def dbPort = 'your_database_port' // Replace with your database port
                    def dbUser = 'your_database_user' // Replace with your database username
                    def dbPassword = 'your_database_password' // Replace with your database password

                    // Attempt to connect to the database
                    try {
                        sh """
                            echo "SELECT 1;" | mysql -h ${dbHost} -P ${dbPort} -u ${dbUser} -p${dbPassword}
                        """
                    } catch (err) {
                        error("Database connection failed: ${err}")
                    }
                }
            }
        }

        stage('MVN TESTS') {
            steps {
                echo 'Running Maven tests...'
                sh 'mvn -f gestion-station-ski/pom.xml test' // Ensure correct path
            }
        }

        stage('NEXUS') {
            steps {
                echo 'Deploying artifact to Nexus...'
                sh 'mvn -f gestion-station-ski/pom.xml deploy' // Ensure correct path
            }
        }

        stage('BUILDING IMAGE') {
            steps {
                script {
                    echo 'Building Docker image...'
                    dockerImage = docker.build registry + ":$BUILD_NUMBER"
                }
            }
        }
        // Add more stages as necessary...
    }
}

