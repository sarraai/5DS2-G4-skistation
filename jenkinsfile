pipeline {
    agent any
    stages {

        stage('Retrieve Code') {
            steps {
                echo 'Cloning repository...'
                // Clone your GitHub repository and select the branch.
                git branch: 'sarra', url: 'https://github.com/sarraai/5DS2-G4-skistation.git'
            }
        }

        stage('Check Maven Installation') {
            steps {
                echo 'Checking Maven version...'
                sh 'mvn -v' // Check Maven version
            }
        }

        stage('Cleaning and Compiling with Maven') {
            steps {
                echo 'Running Maven clean and compile...'
                dir('src') {
                    sh 'mvn clean compile'
                }
            }
        }

        stage('Unit Tests') {
            steps {
                echo 'Running Unit Tests: '
                dir('src') {
                    sh 'mvn test'
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                echo 'Code Quality Analysis: '
                dir('src') {
                    sh 'mvn sonar:sonar -Dsonar.login=admin -Dsonar.password=123BIZERTE@cab456'
                }
            }
        }

        stage('Maven Package') {
            steps {
                echo 'Creating Package: '
                dir('src') {
                    sh 'mvn package -DskipTests'
                }
            }
        }

        stage('Deploy to Nexus') {
            steps {
                echo 'Deploying to Nexus: '
                dir('src') {
                    sh 'mvn deploy -DskipTests'
                }
            }
        }

        stage('Check Docker Installation') {
            steps {
                echo 'Checking Docker installation...'
                sh 'docker --version' // Check Docker version
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'Building Docker Image: '
                dir('..') { // Navigate to the parent directory to build Docker image
                    sh 'docker build -t sarraai/skistation:1.0.0 -f src/Dockerfile src'
                }
            }
        }

        stage('Push to DockerHub') {
            steps {
                echo 'Pushing Image to DockerHub: '
                withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                    sh 'docker login -u $DOCKER_USER -p $DOCKER_PASS'
                }
                sh 'docker push sarraai/skistation:1.0.0'
            }
        }

        stage('Start Backend and DB with Docker Compose') {
            steps {
                echo 'Starting Backend and Database: '
                sh 'docker-compose -f src/docker-compose.yml up -d'
            }
        }

        stage('Launch Prometheus') {
            steps {
                echo 'Launching Prometheus: '
                sh 'docker run -d --name prometheus -p 9090:9090 prom/prometheus'
            }
        }

        stage('Launch Grafana') {
            steps {
                echo 'Launching Grafana: '
                sh 'docker run -d --name grafana -p 3000:3000 grafana/grafana'
            }
        }
    }
}









