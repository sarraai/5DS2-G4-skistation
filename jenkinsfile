pipeline {
    environment {
        registry = "sarraai/skiexam"
        registryCredential = 'dockerHub'
        dockerImage = ''
    }
    agent any

    stages {
        
        stage('CHECKOUT GIT') {
            steps {
                echo 'Cloning GitHub repository...'
                git branch: 'sarra', url: 'https://github.com/sarraai/5DS2-G4-skistation.git'
            }
        }

        stage('MVN CLEAN') {
            steps {
                echo 'Running Maven clean...'
                sh 'mvn -f gestion-station-ski/pom.xml clean' // Update path here if necessary
            }
        }

        stage('ARTIFACT CONSTRUCTION') {
            steps {
                echo 'Building Maven package...'
                sh 'mvn -f gestion-station-ski/pom.xml package -Dmaven.test.skip=true -P test-coverage' // Ensure correct path
            }
        }

        stage('MVN TESTS') {
            steps {
                echo 'Running Maven tests...'
                sh 'mvn -f gestion-station-ski/pom.xml test' // Ensure correct path
            }
        }

        stage('NEXUS') {
            steps {
                echo 'Deploying artifact to Nexus...'
                sh 'mvn -f gestion-station-ski/pom.xml deploy' // Ensure correct path
            }
        }

        stage('BUILDING IMAGE') {
            steps {
                script {
                    echo 'Building Docker image...'
                    dockerImage = docker.build registry + ":$BUILD_NUMBER"
                }
            }
        }

        stage('DEPLOY THE IMAGE') {
            steps {
                script {
                    echo 'Pushing Docker image to DockerHub...'
                    docker.withRegistry('https://index.docker.io/v1/', registryCredential) {
                        dockerImage.push()
                    }
                }
            }
        }
        
        stage('Docker Compose Up') {
            steps {
                script {
                    echo 'Starting services with Docker Compose...'
                    sh """
                        export REGISTRY=${registry}
                        export BUILD_NUMBER=${env.BUILD_NUMBER}
                        docker-compose -f gestion-station-ski/docker-compose.yml up -d
                    """
                }
            }
        }
    }
}
